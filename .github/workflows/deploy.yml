name: CI/CD Pipeline for MERN Stack App

# Run this workflow on every push to the main branch
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted  # Use self-hosted GitHub Runner (local machine)

    steps:
    # Step 1: Check out the code from the GitHub repository
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Set up Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '14'  # Use the Node.js version required by your project

    # Step 3: Install dependencies for both client and server
    - name: Install dependencies
      run: |
        cd client && npm install  # Install client dependencies
        cd ../server && npm install  # Install server dependencies

    # Step 4: Build the client-side React app
    - name: Build client
      run: npm run build
      working-directory: ./client

    # Step 5: Restart the server using PM2 (Process Manager)
    - name: Restart the server using PM2
      run: |
        pm2 stop mern-server || true  # Stop the server if it's already running
        pm2 start index.js --name "mern-server"  # Restart the server
      working-directory: ./server  # Run PM2 in the server folder
